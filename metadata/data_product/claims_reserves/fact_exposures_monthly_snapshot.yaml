target:
  lakehouse: den_lhw_dpr_001_data_product_tables
  schema: reserves
  table: fact_exposures_monthly_snapshot
  load_strategy: overwrite
  key_columns:
    - dl_row_hash
  unknown_record: False
  identity: False

source:
  - name: bop_exposures_summary
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: BOPExposuresSummary

  - name: ca_exposures_summary
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: CAExposuresSummary

  - name: db_exposures_summary
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: DBExposuresSummary

  - name: ho_exposures_summary
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: HOExposureSummary

  - name: wc_exposures_summary
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: WCPremiumExposureSummary

  - name: dim_line_of_business
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: dim_line_of_business

  - name: dim_carrier
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: dim_carrier

  - name: dim_state
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: dim_state

  - name: dim_aslob
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: dim_aslob

query:

  - name: BOPExposuresSummary_DF
    sql: |
        SELECT DISTINCT
          aslob
          ,lob
          ,carrier
          ,state
          ,p.startdate
          ,p.asofdate
          ,p.calyrmo_end
          ,p.polyrmo_end
          ,p.resseg
          ,cast(p.earnedexposure as float) as earned_exposures
          ,cast(p.writtenexposure as float) as written_exposures
          ,case when p.earnedexposure > 0 then 1 else 0 end as dq_earned_exposures_check
          ,case 
                  when p.writtenexposure > 0 then 1
                  else 0
              end as dq_written_exposures_check
        FROM bop_exposures_summary p

  - name: CAExposuresSummary_DF
    sql: |
        SELECT DISTINCT
            aslob
          ,lob
          ,carrier
          ,state
          ,p.startdate
          ,p.asofdate
          ,p.calyrmo_end
          ,p.polyrmo_end
          ,p.resseg
          ,cast(p.earnedexposure as float) as earned_exposures
          ,cast(p.writtenexposure as float) as written_exposures
          ,case when p.earnedexposure > 0 then 1 else 0 end as dq_earned_exposures_check
          ,case 
                  when p.writtenexposure > 0 then 1
                  else 0
              end as dq_written_exposures_check
          FROM ca_exposures_summary p

  - name: DBExposuresSummary_DF
    sql: |
        SELECT DISTINCT
            aslob
          ,lob
          ,carrier
          ,state
          ,p.startdate
          ,p.asofdate
          ,p.calyrmo_end
          ,p.polyrmo_end
          ,cast(null as string) as resseg
          ,cast(p.earnedexposure as float) as earned_exposures
          ,cast(p.writtenexposure as float) as written_exposures
          ,case when p.earnedexposure > 0 then 1 else 0 end as dq_earned_exposures_check
          ,case 
                  when p.writtenexposure > 0 then 1
                  else 0
              end as dq_written_exposures_check
          FROM db_exposures_summary p


  - name: HOExposuresSummary_DF
    sql: |
        SELECT DISTINCT
            aslob
          ,lob
          ,carrier
          ,state
          ,p.startdate
          ,p.asofdate
          ,p.calyrmo_end
          ,p.polyrmo_end
          ,p.resseg
          ,cast(p.earnedexposure as float) as earned_exposures
          ,cast(p.writtenexposure as float) as written_exposures
          ,case when p.earnedexposure > 0 then 1 else 0 end as dq_earned_exposures_check
          ,case 
                  when p.writtenexposure > 0 then 1
                  else 0
              end as dq_written_exposures_check
          FROM ho_exposures_summary p

  - name: WCExposuresSummary_DF
    sql: |
        SELECT DISTINCT
           aslob
          ,lob
          ,carrier
          ,state
          ,p.startdate
          ,p.asofdate
          ,p.calyrmo_end
          ,p.polyrmo_end
          ,p.resseg
          ,cast(p.earnedexposure as float) as earned_exposures
          ,cast(p.writtenexposure as float) as written_exposures
          ,case when p.earnedexposure > 0 then 1 else 0 end as dq_earned_exposures_check
          ,case 
                  when p.writtenexposure > 0 then 1
                  else 0
              end as dq_written_exposures_check
          FROM wc_exposures_summary p

  - name: fact_exposures_monthly_snapshot
    sql: with cteCombined AS 
        (
          select * from BOPExposuresSummary_DF
          union
          select * from CAExposuresSummary_DF
          union
          select * from DBExposuresSummary_DF
          union
          select * from HOExposuresSummary_DF
          union
          select * from WCExposuresSummary_DF
        )
        select distinct
            cast(null as int) as fact_exposures_monthly_snapshot_key
            ,coalesce(asl.aslob_key, -1) as aslob_key
            ,coalesce(lob.line_of_business_key, -1) as line_of_business_key
            ,coalesce(car.carrier_key, -1) as carrier_key
            ,coalesce(st.state_key, -1) as state_key
            ,current_timestamp() as snapshot_timestamp
            ,startdate
            ,asofdate
            ,cast(calyrmo_end as date) as cal_yr_mo_end
            ,polyrmo_end as policy_effective_date
            ,cast(calyrmo_end as date) as loss_date
            ,cast(calyrmo_end as date) as first_entered_date
            ,resseg as reserve_segment_code
            ,earned_exposures
            ,written_exposures
            ,dq_earned_exposures_check
            ,dq_written_exposures_check
            ,cast(null as timestamp) as row_effective_date
            ,cast(null as timestamp) as row_expiration_date
            ,cast(null as boolean) as is_current_flag
        from cteCombined c

        LEFT JOIN dim_line_of_business lob
            ON lob.line_of_business_code = c.lob and lob.dl_is_current_flag = 1
    
        LEFT JOIN dim_carrier car
            ON car.carrier_code = c.carrier and car.dl_is_current_flag = 1
    
        LEFT JOIN dim_state st
            ON st.state_code = c.state and st.dl_is_current_flag = 1
    
        LEFT JOIN dim_aslob asl
            ON asl.aslob_code = c.aslob and asl.dl_is_current_flag = 1

