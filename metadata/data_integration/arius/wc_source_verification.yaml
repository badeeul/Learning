target:
  lakehouse: den_lhw_dpr_001_data_product_tables
  schema: arius
  table: wc_source_verification
  load_strategy: overwrite
  key_columns:
  unknown_record: False
  identity: False

source:
  - name: claimant
    lakehouse: den_lhw_scu_001_tables_for_data_product_zone
    schema: iis
    table: claimant

  - name: wcclaim
    lakehouse: den_lhw_scu_001_tables_for_data_product_zone
    schema: iis
    table: wcclaim

  - name: payments
    lakehouse: den_lhw_scu_001_tables_for_data_product_zone
    schema: iis
    table: payments

  - name: insured
    lakehouse: den_lhw_scu_001_tables_for_data_product_zone
    schema: iis
    table: insured

  - name: cl_occurrence
    lakehouse: den_lhw_scu_001_tables_for_data_product_zone
    schema: iis
    table: cl_occurrence

  - name: reserves
    lakehouse: den_lhw_scu_001_tables_for_data_product_zone
    schema: iis
    table: reserves

query:
  - name: wc_pd
    sql:  |
      with cte_pd as (
        select 
          i.lob,
          year(w.dol) as dolyear,
          i.carrier,
          to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59')) as asofdate,
          nvl((select sum(amount) from payments p where p.claimantid = c.claimantid and chkdate <= to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59')) and typepmt in ('M','I')),0) as losses,
          nvl((select sum(amount) from payments p where p.claimantid = c.claimantid and chkdate  <= to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59')) and typepmt = 'E'),0) as expense,
          nvl((select sum(amount) from payments p where p.claimantid = c.claimantid and chkdate  <= to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59'))),0) as total
        from wcclaim w
        inner join claimant c on c.wcclaimid = w.wcclaimid and c.dl_iscurrent = 1
        inner join insured i on i.code = w.code and i.dl_iscurrent = 1
        where w.dol is not null
          and ((i.LOB in ('WC'))) 
          and w.dl_iscurrent = 1
      )
      select 
          lob
        , dolyear
        , carrier
        , asofdate
        , sum(losses) as LossPaid
        , sum(expense) as ExpensePaid
        , sum(total) as TotalPaid
      from cte_pd
      group by lob, carrier, dolyear, asofdate

  - name: wc_os
    sql: |
      select
          year(w.dol) as dolyear,
          i.carrier,		
          i.lob,	
          nvl((select sum(medical) from reserves r where r.claimantid = cl.claimantid and updateon <=to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59'))),0) as totalMedReserves,	
          nvl((select sum(amount) From payments p where p.claimantid = cl.claimantid and p.chkdate <= to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59')) and typepmt in ('M')), 0) as totalMedPaid,		
          nvl((select sum(indemnity) from reserves r where r.claimantid = cl.claimantid and updateon <=to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59'))),0) as totalIndReserves,
          nvl((select sum(amount) From payments p where p.claimantid = cl.claimantid and p.chkdate <= to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59')) and typepmt in ('I','L','D')), 0) as totalIndPaid,
          nvl((select sum(expense) from reserves r where r.claimantid = cl.claimantid and updateon <=to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59'))),0) as TotalExpReserves,
          nvl((select sum(amount) From payments p where p.claimantid = cl.claimantid and p.chkdate <= to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59')) and typepmt  in ('E','X')), 0) as TotalExpPaid
      from wcclaim w		
      left outer join cl_occurrence o on o.occid = w.occid and o.dl_iscurrent = 1
      inner join claimant cl on cl.wcclaimid = w.wcclaimid and cl.dl_iscurrent = 1
      inner join insured i on i.code = w.code and i.dl_iscurrent = 1
      where ((i.LOB in ('WC')))		
        and (w.dol is not null)
        and w.dl_iscurrent = 1 

  - name: wc_os2
    sql: |
      select 		
        lob,
        dolyear, 
        carrier,		
        sum(totalMedReserves) - sum(totalMedPaid) as MedicalOS,
        sum(totalIndReserves) - sum(totalIndPaid) as LossOS,
        sum(TotalExpReserves) - sum(TotalExpPaid) as ExpenseOS,
        (sum(totalMedReserves) - sum(totalMedPaid)) +(sum(totalIndReserves) - sum(totalIndPaid)) + (sum(TotalExpReserves) - sum(TotalExpPaid)) as TotalOS
      from wc_os 		
      group by dolyear, lob, carrier	

  - name: wc_pdos
    sql: |
      select 
        pd.lob,
        pd.dolyear,
        pd.carrier,
        to_timestamp(date_format(last_day(add_months(current_timestamp, -1)), 'yyyy-MM-dd 23:59:59')) as asofdate,
        pd.LossPaid,
        pd.ExpensePaid,
        pd.TotalPaid,
        os.MedicalOS, 
        os.LossOS, 
        os.ExpenseOS, 
        os.TotalOS
      from wc_pd pd
      join wc_os2 os on pd.dolyear = os.dolyear and pd.carrier = os.carrier