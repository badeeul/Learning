target:
  lakehouse: den_lhw_dpr_001_data_product_tables
  schema: arius
  table: incremental_exposures_summary
  load_strategy: overwrite
  unknown_record: False
  identity: False

source:
  - name: fact_exposures_monthly_snapshot
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: fact_exposures_monthly_snapshot

  - name: dim_line_of_business
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: dim_line_of_business

  - name: dim_carrier
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: dim_carrier

  - name: dim_aslob
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: dim_aslob

  - name: dim_state
    lakehouse: den_lhw_dpr_001_data_product_tables
    schema: reserves
    table: dim_state
    
query:
  - name: incremental_exposures_summary
    sql: SELECT 
          '' as ClaimNum
          ,case when fct.state_key = -1 then '' else st.state_code end as state
          ,case when fct.line_of_business_key = -1 then '' else lob.line_of_business_code end as lob
          ,case when fct.carrier_key = -1 then '' else car.carrier_code end as carrier
          ,'' as agency
          ,'' as marketType
          ,'' as productionsrc
          ,cast(fct.policy_effective_date as date) as PolicyEffectiveDate
          ,cal_yr_mo_end as CalYrMo_End
          ,loss_date as LossDate
          ,first_entered_date as FirstEnteredDate
          ,'' as CauseOfLoss
          ,'' as LossDescrip
          ,'' as CATCode
          ,'' as HandledByLegalInd
          ,'' as SuitFiledInd
          ,'' as TPAInd
          ,'' as CWPFinalInd
          ,'' as MASSIND
          ,'' as CATInd
          ,case when fct.aslob_key = -1 then '' else asl.aslob_code end as aslob
          ,'' as TransmittalSeg
          ,reserve_segment_code as ResSeg
          ,'' as DetailedResSeg
          ,'' as MedOnlyInd
          ,'0' as EarnedPremium
          ,'0' as WrittenPremium
          ,cast(fct.earned_exposures as float) as EarnedExposures
          ,cast(fct.written_exposures as float) as WrittenExposures
          ,fct.snapshot_timestamp

        FROM 
            fact_exposures_monthly_snapshot fct
        JOIN 
            dim_line_of_business lob on fct.line_of_business_key = lob.line_of_business_key and  lob.dl_is_current_flag = 1
        JOIN 
          dim_state st on fct.state_key = st.state_key and st.dl_is_current_flag = 1
        JOIN 
          dim_aslob asl on fct.aslob_key = asl.aslob_key and asl.dl_is_current_flag = 1
        JOIN 
          dim_carrier car on fct.carrier_key = car.carrier_key and car.dl_is_current_flag = 1
        WHERE snapshot_timestamp = (select max(snapshot_timestamp) as max_snapshot from fact_exposures_monthly_snapshot)